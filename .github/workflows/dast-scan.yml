name: OWASP ZAP Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start ZAP daemon
        run: docker run -u zap -d -p 8080:8080 -v $(pwd):/zap/wrk/:rw --name zap ghcr.io/zaproxy/zaproxy:stable zap.sh -daemon -port 8080 -host 0.0.0.0 -config api.disablekey=true

      - name: Wait for ZAP to start
        run: sleep 15

      - name: Run ZAP Baseline Scan
        run: |
          # Run ZAP baseline scan with multiple report formats
          docker exec zap zap-baseline.py -t http://localhost:8080 -r /zap/wrk/testreport.html -J /zap/wrk/testreport.json -x /zap/wrk/testreport.xml || true
          echo "ZAP scan completed"

      - name: List files in working directory
        run: |
          echo "Files in current directory:"
          ls -la
          echo "Files in /zap/wrk inside container:"
          docker exec zap ls -la /zap/wrk/

      - name: Copy reports from container
        run: |
          # Copy all report files from container
          docker cp zap:/zap/wrk/testreport.html ./testreport.html || echo "HTML report not found"
          docker cp zap:/zap/wrk/testreport.json ./testreport.json || echo "JSON report not found"
          docker cp zap:/zap/wrk/testreport.xml ./testreport.xml || echo "XML report not found"
          
          # List what we actually have
          echo "Available report files:"
          ls -la testreport.* || echo "No report files found"

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: testreport.*
          if-no-files-found: warn
